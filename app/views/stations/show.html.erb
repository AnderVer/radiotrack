<% content_for :title, "#{@station.title} ‚Äî RadioTrack" %>

<div class="main">
  <!-- Station header -->
  <div class="mb-3">
    <%= link_to "‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", root_path, class: "text-muted" %>
  </div>

  <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
    <div>
      <h1 class="mb-2">
        <%= @station.title %>
        <% if @station.code == "avtoradio" %>
          <span class="badge badge-success">MVP</span>
        <% end %>
        <% if @station.has_public_playlist? %>
          <span class="badge badge-primary">–ü–ª–µ–π–ª–∏—Å—Ç</span>
        <% end %>
      </h1>
      <p class="text-muted">
        <code><%= @station.code %></code>
        <% if @station.federal %>
          <span class="badge badge-warning">–§–µ–¥–µ—Ä–∞–ª—å–Ω–∞—è</span>
        <% end %>
      </p>
    </div>
    <div style="display: flex; gap: 8px; align-items: center;">
      <% if user_signed_in? %>
        <% bookmark = current_user.station_bookmarks.find_by(station: @station) %>
        <% if bookmark %>
          <%= button_to "‚òÖ –í –∑–∞–∫–ª–∞–¥–∫–∞—Ö", bookmark_path(@station), method: :delete, class: "btn btn-secondary" %>
        <% else %>
          <%= button_to "‚òÜ –í –∑–∞–∫–ª–∞–¥–∫–∏", bookmarks_path(station_id: @station.id), method: :post, class: "btn btn-primary" %>
        <% end %>
      <% end %>
      <%= link_to "üéß –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç", @station.player_url, target: "_blank", rel: "noopener", class: "btn btn-secondary" %>
      <% if @station.stream_url.present? %>
        <%= link_to "‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å", @station.stream_url, target: "_blank", rel: "noopener", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>
</div>

<!-- Last track (Paid feature) -->
<div class="main">
  <h2 class="mb-3">üéµ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç—Ä–µ–∫</h2>

  <% if user_signed_in? && current_user.can_access_last_track? %>
    <% if @station.last_track %>
      <div class="track-now" style="padding: 20px;">
        <div style="font-size: 20px;">
          <span class="track-artist" style="font-size: 20px;"><%= @station.last_track.artist %></span>
          <span> ‚Äî </span>
          <span class="track-title" style="font-size: 20px;"><%= @station.last_track.title %></span>
        </div>
        <div class="track-time" style="margin-top: 8px;">
          –í —ç—Ñ–∏—Ä–µ: <%= l @station.last_track.played_at, format: :long %>
        </div>
        <div class="text-sm text-muted mt-2">
          –ò—Å—Ç–æ—á–Ω–∏–∫: <%= @station.last_track.source %> ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: <%= (@station.last_track.confidence * 100).round %>%
        </div>
      </div>
    <% else %>
      <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–µ–∫–µ</p>
    <% end %>
  <% else %>
    <div class="paywall">
      <h3>üîí –î–æ—Å—Ç—É–ø–Ω–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</h3>
      <p>–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ç—Ä–µ–∫—É –∏ –¥—Ä—É–≥–∏–º —Ñ—É–Ω–∫—Ü–∏—è–º</p>
      <ul class="paywall-features" style="text-align: left; display: inline-block;">
        <li>‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç—Ä–µ–∫ –≤ —ç—Ñ–∏—Ä–µ</li>
        <li>‚úÖ –ü–ª–µ–π–ª–∏—Å—Ç —ç—Ñ–∏—Ä–∞ –∑–∞ 30 –º–∏–Ω—É—Ç</li>
        <li>‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ "–ë—É–¥–µ—Ç —Å–∫–æ—Ä–æ"</li>
        <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ –ø–ª–µ–π–ª–∏—Å—Ç</li>
      </ul>
      <div class="mt-3">
        <% if user_signed_in? %>
          <%= link_to "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "#", class: "btn paywall-btn" %>
        <% else %>
          <%= link_to "–í–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", new_user_session_path, class: "btn paywall-btn" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Recent tracks -->
<div class="main">
  <h2 class="mb-3">üìã –ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–µ–∫–∏</h2>

  <% if @recent_tracks.any? %>
    <ul class="station-list">
      <% @recent_tracks.each do |track| %>
        <li class="station-item">
          <div class="station-info">
            <div>
              <span class="track-artist"><%= track.artist %></span>
              <span> ‚Äî </span>
              <span class="track-title"><%= track.title %></span>
            </div>
            <div class="track-time">
              <%= l track.played_at, format: :time %> ‚Ä¢ <%= l track.played_at, format: :date %>
            </div>
            <div class="text-sm text-muted mt-2">
              –ò—Å—Ç–æ—á–Ω–∏–∫: <%= track.source %> ‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: <%= (track.confidence * 100).round %>%
            </div>
          </div>
        </li>
      <% end %>
    </ul>
  <% else %>
    <p class="text-muted">–¢—Ä–µ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
  <% end %>
</div>

<!-- Playlist feature (Paid) -->
<div class="main">
  <h2 class="mb-3">üìª –ü–ª–µ–π–ª–∏—Å—Ç —ç—Ñ–∏—Ä–∞</h2>

  <% if user_signed_in? && current_user.can_access_playlist? %>
    <div style="background: #f0f7ff; border: 1px solid #b3d9ff; border-radius: 4px; padding: 16px;">
      <p class="mb-2">
        <strong>–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞ 30 –º–∏–Ω—É—Ç</strong> ‚Äî –≤—Å–µ —Ç—Ä–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–≥—Ä–∞–ª–∏ –≤ —ç—Ñ–∏—Ä–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
      </p>
      <%= link_to "–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç", "#", class: "btn btn-primary btn-sm" %>
      <p class="text-sm text-muted mt-2">
        –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–ª–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç —ç—Ñ–∏—Ä–∞
      </p>
    </div>
  <% else %>
    <div class="paywall">
      <h3>üîí –ü–ª–µ–π–ª–∏—Å—Ç —ç—Ñ–∏—Ä–∞</h3>
      <p>–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–ª–µ–π–ª–∏—Å—Ç—É —ç—Ñ–∏—Ä–∞ –∑–∞ 30 –º–∏–Ω—É—Ç</p>
      <% unless user_signed_in? %>
        <%= link_to "–í–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", new_user_session_path, class: "btn paywall-btn" %>
      <% else %>
        <%= link_to "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "#", class: "btn paywall-btn" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Capture now playing (Paid) -->
<% if user_signed_in? && current_user.can_capture_now_playing? %>
  <div class="main">
    <h2 class="mb-3">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫</h2>
    <div style="background: #fff7e6; border: 1px solid #ffd699; border-radius: 4px; padding: 16px;">
      <p class="mb-2">
        <strong>Capture now playing</strong> ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏–∑ —ç—Ñ–∏—Ä–∞ –≤ —Å–≤–æ–π –ø–ª–µ–π–ª–∏—Å—Ç
      </p>
      <%= form_with url: capture_now_playing_api_station_path(@station), method: :post, local: true do |f| %>
        <div style="display: flex; gap: 8px; align-items: center;">
          <label style="font-weight: 500;">–í –ø–ª–µ–π–ª–∏—Å—Ç:</label>
          <%= select_tag :playlist_id, options_from_collection_for_select(current_user.playlists, :id, :title), prompt: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç", class: "form-control", style: "padding: 8px; min-width: 200px;" %>
          <%= submit_tag "–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫", class: "btn btn-primary" %>
        </div>
      <% end %>
      <p class="text-sm text-muted mt-2">
        –¢—Ä–µ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–∏–≥—Ä–∞–µ—Ç –≤ —ç—Ñ–∏—Ä–µ
      </p>
    </div>
  </div>
<% end %>

<!-- Where soon forecast (Paid) -->
<div class="main">
  <h2 class="mb-3">üîÆ –ë—É–¥–µ—Ç —Å–∫–æ—Ä–æ</h2>

  <% if user_signed_in? && current_user.can_access_forecast? %>
    <div style="background: #f0fff4; border: 1px solid #99ffcc; border-radius: 4px; padding: 16px;">
      <p class="mb-2">
        <strong>–ü—Ä–æ–≥–Ω–æ–∑</strong> ‚Äî —É–∑–Ω–∞–π—Ç–µ, –∫–æ–≥–¥–∞ —ç—Ç–æ—Ç —Ç—Ä–µ–∫ —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –≤ —ç—Ñ–∏—Ä–µ
      </p>
      <p class="text-muted">
        –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ —ç—Ñ–∏—Ä–∞
      </p>
    </div>
  <% else %>
    <div class="paywall">
      <h3>üîí –ü—Ä–æ–≥–Ω–æ–∑ "–ë—É–¥–µ—Ç —Å–∫–æ—Ä–æ"</h3>
      <p>–£–∑–Ω–∞–π—Ç–µ, –∫–æ–≥–¥–∞ —Ç—Ä–µ–∫ —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –≤ —ç—Ñ–∏—Ä–µ</p>
      <% unless user_signed_in? %>
        <%= link_to "–í–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", new_user_session_path, class: "btn paywall-btn" %>
      <% else %>
        <%= link_to "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "#", class: "btn paywall-btn" %>
      <% end %>
    </div>
  <% end %>
</div>
